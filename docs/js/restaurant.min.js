"use strict";var mapBoxLayer=null,mapMarkers=[],mapTimeout=0,mapInitializing=!1,mapLoaded=!1,toggleMap=function(){var a=self.mapButton.getAttribute("aria-label").split(" ")[0].toLowerCase();(toggleMapButtonDisplay(a),self.mapLoaded)?(toggleMapDisplay("show"===a),"restaurant"!==InterfaceManager.getUserView()&&(self.neighborhoodSelectWidget.closeSelectBox("null",!0),self.cuisineSelectWidget.closeSelectBox("null",!0))):initMap(getMapInitParams())},toggleMapButtonDisplay=function(a){var e="show"===a?"hide":"show",t=getMabButtonLabelTitle(e);self.mapButton.setAttribute("aria-label",t),self.mapButton.title=t,"hide"===e?(self.mapButton.classList.remove("location_icon","fa-map-marker-alt"),self.mapButton.classList.add("map_icon","fa-map")):(self.mapButton.classList.remove("map_icon","fa-map"),self.mapButton.classList.add("location_icon","fa-map-marker-alt"))},getMabButtonLabelTitle=function(a){var e=a+" "+("restaurant"===InterfaceManager.getUserView()?"restaurant":"results")+" "+("show"===a?"on":"from")+" map";return e.charAt(0).toUpperCase()+e.slice(1)},getMapInitParams=function(){return"restaurant"===InterfaceManager.getUserView()?{lat:self.restaurant.latlng.lat,lng:self.restaurant.latlng.lng,zoomLevel:16,restaurants:[self.restaurant]}:{lat:40.722216,lng:-73.987501,zoomLevel:12,restaurants:self.restaurants}},resetMap=function(){self.mapBoxLayer=null,removeMarkers(),self.mapTimeout=0,self.mapInitializing=!1,self.mapLoaded=!1},initMap=function(a){resetMap(),self.mapInitializing=!0,displayMap(),setTimeout(function(){Promise.all([FileLoader.loadFile("link",appParams.mapBox.cssFile),FileLoader.loadFile("script",appParams.mapBox.jsFile)]).then(function(){self.mapBoxLayer=new L.map("map",{center:[a.lat,a.lng],zoom:a.zoomLevel,scrollWheelZoom:!1}),L.tileLayer(appParams.mapBox.leaflet_tile_layer_link,appParams.mapBox.leaflet_params).addTo(self.mapBoxLayer),self.mapLoaded=!0,addMarkersToMap(a.restaurants),self.mapInitializing=!1}).catch(function(a){self.mapLoaded=!1,mapFailure()})},700)},displayMap=function(){InterfaceManager.displayElement(self.mapContainer),self.mapTimeout=setTimeout(function(){self.mapContainer.classList.add(appParams.cssClasses.displayMap)},200)},hideMap=function(){self.mapContainer.classList.remove(appParams.cssClasses.displayMap),self.mapTimeout=setTimeout(function(){InterfaceManager.hideElement(self.mapContainer)},800)},toggleMapDisplay=function(a){self.mapLoaded?self.mapInitializing||(clearTimeout(self.mapTimeout),a?displayMap():hideMap()):mapFailure()},addMarkersToMap=function(a){self.mapBoxLayer&&self.mapLoaded&&a.forEach(function(a){var e={title:a.name,alt:a.name,url:DBHelper.urlForRestaurant(a)},t=new L.marker([a.latlng.lat,a.latlng.lng],e);t.addTo(self.mapBoxLayer),self.mapMarkers.push(t);var l=function(){window.location.href=t.options.url};t.on("click",l),t.on("keypress",function(a){13===a.originalEvent.keyCode&&l()})})},removeMarkers=function(){self.mapBoxLayer&&self.mapLoaded&&self.mapMarkers&&self.mapMarkers.length>0&&self.mapMarkers.forEach(function(a){return a.remove()}),self.mapMarkers=[]},enableMap=function(){self.mapButton.setAttribute("onclick","toggleMap(event)"),self.mapButton.classList.remove(appParams.cssClasses.disableMapButton),toggleMapButtonDisplay("hide")},disableMap=function(){self.mapContainer.classList.remove(appParams.cssClasses.displayMap),InterfaceManager.hideElement(self.mapContainer),self.mapButton.removeAttribute("onclick"),self.mapButton.classList.add(appParams.cssClasses.disableMapButton),toggleMapButtonDisplay("hide"),self.mapButton.setAttribute("aria-label","Map is currently unavailable"),self.mapButton.title="Map is currently unavailable",self.mapButton.blur(),resetMap()},mapFailure=function(){disableMap(),generateBasicNotification(getNotificationContent("map_failure"),0)};
"use strict";var createFavoriteBookmark=function(t){var e=document.createElement("div");e.classList.add("favoriteToggler");var a=document.createElement("div");a.classList.add("fas","fa-bookmark","favoriteBookmark");var r=InterfaceManager.createButton("favoriteBookmark_"+t._id,"","mark restaurant as favorite",toggleFavorite);return r.title="mark restaurant as favorite",r.classList.add("fas","fa-heart","favoriteButton"),e.append(a,r),toggleFavoriteDisplay(r,t.is_favorite),e},toggleFavoriteDisplay=function(t,e){var a="true"===e.toString();t.setAttribute("aria-pressed",a);var r=!0===a?"Unmark restaurant from favorites!":"Add restaurant to favorites!",s=!0===a?"remove restaurant from favorites":"mark restaurant as favorite";t.setAttribute("title",r),t.setAttribute("aria-label",s);var i=!0===a?"favored":"unFavorite",n=!0===a?"unFavorite":"favored";t.classList.remove(n),t.classList.add(i)},toggleFavorite=function(t){t.preventDefault();var e=t.target.getAttribute("id").split("_").pop(),a=document.getElementById("favoriteBookmark_"+e),r="true"!==a.getAttribute("aria-pressed").toString();a.blur(),DBHelper.favoriteHandler(e,r).then(function(t){switch(t.request_status){case"fail":generateFailureNotification(DBHelper.INDEXED_DB_SUPPORT),DBHelper.INDEXED_DB_SUPPORT&&(toggleFavoriteDisplay(a,r),updateRestaurantVarsOnFail({_id:e,is_favorite:r}));break;default:toggleFavoriteDisplay(a,r),updateRestaurantVars(t.data)}})},updateRestaurantVarsOnFail=function(t){if("restaurant"===InterfaceManager.getUserView())self.restaurant.is_favorite=t.is_favorite,DBHelper.updateIndexedDB({target:"restaurant",data:self.restaurant},"PUT");else{var e=self.restaurants.filter(function(e){return e._id!==t._id}),a=self.restaurants.filter(function(e){return e._id===t._id})[0];a.is_favorite=t.is_favorite,DBHelper.updateIndexedDB({target:"restaurant",data:a},"PUT"),e.push(a),e.sort(function(t,e){return DBHelper.sortByID(t,e,"asc")}),self.restaurants=[],self.restaurants=e}},updateRestaurantVars=function(t){if("restaurant"===InterfaceManager.getUserView())self.restaurant=t;else{var e=self.restaurants.filter(function(e){return e._id!=t._id});e.push(t),e.sort(function(t,e){return DBHelper.sortByID(t,e,"asc")}),self.restaurants=[],self.restaurants=e}};
"use strict";var restaurant=void 0,reviews=void 0,reviewsResults=void 0,reviewsList=void 0,reviewLayer=void 0,reviewModal=void 0,ratingStars=void 0,renderRestaurantInfo=function(){self.reviewsResults=document.getElementById("reviews"),self.reviewsList=document.getElementById("reviewsList"),self.reviewLayer=document.getElementById("add_review_wrapper"),self.reviewModal=document.getElementById("add_review_modal");var e=document.querySelectorAll(".rrstar"),t=Array.prototype.slice.call(e,0);self.ratingStars=t.reverse(),fetchRestaurantFromURL(function(e,t){e?console.error(e):(self.restaurant=t,fillBreadcrumb(),fillRestaurantHTML())}),self.reviewLayer.addEventListener("keydown",trapModalKeys)},fetchRestaurantFromURL=function(e){if(self.restaurant)e(null,self.restaurant);else{var t=InterfaceManager.getParameterByName("id");t?DBHelper.fetchRestaurantById(t,function(t,r){self.restaurant=r,r?e(null,r):console.error(t)}):(error="No restaurant id in URL",e(error,null))}},fillBreadcrumb=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurant,t=document.getElementById("breadcrumb"),r=document.createElement("li"),a=document.createElement("a");a.innerHTML=e.name,a.href=DBHelper.urlForRestaurant(e),a.setAttribute("aria-current","page"),r.append(a),t.appendChild(r)},fillRestaurantHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurant;document.getElementById("restaurantName").innerHTML=e.name,document.querySelectorAll(".imageContainer")[0].append(createFavoriteBookmark(e));var t=document.getElementById("restaurantImg");t.alt="photo of restaurant: "+e.name,t.className="restaurantImg",t.src=DBHelper.imageUrlForRestaurant(e),document.getElementById("cuisine").innerHTML=e.cuisine_type,document.getElementById("address").innerHTML="<span>"+e.neighborhood+"</span><span>"+e.address+"</span>",e.operating_hours&&fillRestaurantHoursHTML(),document.getElementById("commentsfield").placeholder='Enter your comments for the restaurant "'+self.restaurant.name+'" here!',DBHelper.fetchRestaurantReviews(e._id,function(e,t){e?console.error(e):(self.reviews=t,fillRatingStats(),fillReviewsHTML(),InterfaceManager.hideLoader())})},fillRestaurantHoursHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurant.operating_hours,t=document.getElementById("restaurantHours");for(var r in e){var a=document.createElement("tr"),n=document.createElement("td");n.className="hoursDay",n.innerHTML=r,a.appendChild(n);var i=document.createElement("td");i.className="hoursTime",i.innerHTML=e[r],a.appendChild(i),t.appendChild(a)}},fillRatingStats=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.reviews,t=document.getElementById("total_rating"),r=document.getElementById("total_reviews"),a=e.length;if(r.innerHTML=a,a>0){var n=0;e.forEach(function(e){n+=parseInt(e.rating)});var i=Number(Math.round(n/a+"e1")+"e-1");t.innerHTML=i}},fillReviewsHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.reviews,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:self.reviewsList;self.reviewsList.innerHTML="",e&&0!==e.length?(e.sort(function(e,t){var r=DBHelper.sortByDate(e,t,"desc","updatedAt"),a=DBHelper.sortByDate(e,t,"desc","createdAt"),n=DBHelper.sortByID(e,t,"desc");return r||a||n}),InterfaceManager.removeNoResultsFetchingeMessage(),e.forEach(function(e){t.appendChild(createReviewHTML(e))})):InterfaceManager.displayNoResultsFetchingMessage("reviews",self.reviewsResults,self.reviewsList)},createReviewHTML=function(e){var t=document.createElement("li");if(t.className="reviewCard",t.setAttribute("role","listitem"),parseInt(e.id)>24||e._id.toString().startsWith("temp")){var r=InterfaceManager.createButton("edit_rev_"+e._id,"","edit review",editReview);r.title="Edit Review",r.classList.add("fas","fa-pencil-alt","review_modification_btn","edirreview");var a=InterfaceManager.createButton("delete_rev_"+e._id,"","delete review",deleteReview);a.title="Delete Review",a.classList.add("fas","fa-trash-alt","review_modification_btn","deletereview"),t.append(a,r)}var n=populateReviewRating(e.rating),i=document.createElement("div");i.className="reviewInfo";var s=document.createElement("p");s.className="reviewer",s.innerHTML='<span>by</span><b title="'+e.name+'">'+e.name+"</b>";var l=document.createElement("p");if(l.className="reviewCreationDate",l.innerHTML=InterfaceManager.formatDate(e.createdAt),i.append(s,l),new Date(e.updatedAt).getTime()>new Date(e.createdAt).getTime()){var d=document.createElement("p");d.className="reviewUpdateDate",d.innerHTML="Last updated: "+InterfaceManager.getDateTime(e.updatedAt),i.append(d)}var o=document.createElement("p");return o.className="ratingComments",o.innerHTML=InterfaceManager.decodeEntities(e.comments),t.append(n,i,o),t},populateReviewRating=function(e){var t=document.createElement("div");t.classList.add("centeredFlexbox","reviewRating");var r=document.createElement("p");r.className="ratingHeader",r.innerHTML="rating:",t.append(r);for(var a=1;a<6;a++){var n=document.createElement("div");n.classList.add("fas","fa-star","star_for_review"),a<=e&&n.classList.add("given_star"),t.append(n)}return t};
"use strict";var focusAfterError=[],reviewInitiator="",reviewsModification="",editableReview=[],editReview=function(e){self.editableReview=[],self.reviewInitiator="",self.reviewsModification="edit",self.reviewInitiator=document.getElementById(e.target.id);var t=e.target.id.split("_").pop();self.editableReview=self.reviews.filter(function(e){return e._id==t})[0],displayAddReviewModal()},toggleReviewForm=function(e){switch(e.target.getAttribute("id").split("_").pop()){case"close":hideAddReviewModal();break;case"open":self.reviewInitiator="",self.reviewInitiator=document.getElementById("rev_btn_open"),self.reviewsModification="add",displayAddReviewModal()}},displayAddReviewModal=function(){"rev_btn_open"===self.reviewInitiator.id?initReviewForm():initEditReviewForm(),InterfaceManager.displayElement(self.reviewLayer),document.getElementById("namefield").focus()},hideAddReviewModal=function(){InterfaceManager.hideElement(self.reviewLayer),initReviewForm(),removeFormErrors(),self.reviewInitiator.focus(),self.editableReview=[],self.reviewsModification="",self.reviewInitiator=""},initRatingStars=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.ratingStars,t=0;t<e.length;t++)e[t].classList.remove("selected"),document.getElementById(e[t].getAttribute("for")).removeAttribute("checked")},checkStars=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:self.ratingStars;initRatingStars();var r=t[e];r.focus();var i=document.getElementById(r.getAttribute("for"));i.setAttribute("checked",!0);for(var a=0;a<i.value;a++)t[a].classList.add("selected")},selectRatingStar=function(e){var t=parseInt(e.target.id.split("star").pop());checkStars((t+4)%5)},getFormErrors=function(e){self.focusAfterError=[];for(var t=[],r=Object.keys(e),i=0;i<r.length;i++){var a=r[i];if("name"===a){var s=textValidation(e.name,2,!0);null!=s&&(t.push(s+" your name!"),self.focusAfterError.push("namefield"))}if("rating"===a&&0==e.rating&&(t.push("Please provide a rating for the restaurant by selecting the respective number of stars!"),self.focusAfterError.push("rrstar_1")),"comments"===a){var n=textValidation(e.comments,1);null!=n&&(t.push(n+" your comments!"),self.focusAfterError.push("commentsfield"))}}return t},textValidation=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=new RegExp("^[0-9]+$"),a=new RegExp("^(?=.*[a-zA-Z]).{2,}$");return""===e?"Please provide":""===e.replace(/\s+/,"")?"Only spaces are NOT allowed for":i.test(e)?"Only numbers are NOT allowed for":e.length<t?"At least "+(1===t?"one character":"two characters")+" are required for":!a.test(e)&&e.length>=2&&!0===r?"At least one letter is required for":null},displayReviewFormErrors=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:self.reviewModal,r=document.createElement("div");r.className="formError",r.setAttribute("role","alert"),r.setAttribute("aria-live","assertive");var i=document.createElement("i");i.classList.add("fas","fa-exclamation-triangle","formwarning");var a=document.createElement("h4");a.className="errortitle",a.innerHTML="There are some errors in your review!";var s=document.createElement("ol");s.setAttribute("id","errorsList"),s.setAttribute("aria-label","error list of review");for(var n=0;n<e.length;n++){var l=document.createElement("li");l.setAttribute("role","listitem"),l.innerHTML=e[n],s.append(l)}var o=InterfaceManager.createButton("error_close_btn","ok","close form errors",closeFormErrors);o.title="Close form errors!",r.append(i,a,s,o),t.append(r),document.getElementById("error_close_btn").focus()},removeFormErrors=function(){var e=document.querySelectorAll(".formError");e.length>0&&e[0].remove(),self.focusAfterError=[]},closeFormErrors=function(e){document.getElementById(self.focusAfterError[0]).focus(),removeFormErrors()},initReviewForm=function(){initRatingStars(),document.getElementById("namefield").value="",document.getElementById("commentsfield").value=""},initEditReviewForm=function(){checkStars(self.editableReview.rating-1),document.getElementById("namefield").value=self.editableReview.name,document.getElementById("commentsfield").value=self.editableReview.comments},clearReviewForm=function(e){e.preventDefault(),initReviewForm(),removeFormErrors()},trapModalKeys=function(e){var t=document.querySelectorAll(".modalfocusable"),r=t[0],i=t[t.length-1],a=e.target.id;if(27===e.keyCode)e.preventDefault(),hideAddReviewModal();else if(13===e.keyCode&&a.startsWith("rrstar_")){e.preventDefault();var s=parseInt(a.split("_").pop());checkStars((s+4)%5)}else if(13===e.keyCode&&"namefield"===a)e.preventDefault();else if(9===e.keyCode&&!0===e.shiftKey){if("rev_btn_close"===a)e.preventDefault(),document.querySelectorAll(".formError").length>0?document.getElementById("error_close_btn").focus():i.focus();else a.startsWith("rrstar_")?(e.preventDefault(),t[1].focus()):"error_close_btn"===a&&(e.preventDefault(),r.focus())}else if(9===e.keyCode&&!1===e.shiftKey){if("error_close_btn"===a||"rev_submit"===a)e.preventDefault(),r.focus();else if("namefield"===a)e.preventDefault(),self.ratingStars[0].focus();else if(a.startsWith("rrstar_"))e.preventDefault(),t[7].focus();else if("rev_btn_close"===a){document.querySelectorAll(".formError").length>0&&(e.preventDefault(),document.getElementById("error_close_btn").focus())}}else if(39!==e.keyCode&&40!==e.keyCode||!a.startsWith("rrstar_")){if(37!==e.keyCode&&38!==e.keyCode||!a.startsWith("rrstar_"))return;e.preventDefault();var n=parseInt(a.split("_").pop());checkStars((n+3)%5)}else{e.preventDefault();var l=a.split("_").pop();checkStars(l)}},getUserInput=function(){var e=document.getElementById("namefield").value.toString().trim(),t=document.querySelector("input[name='userrating']:checked"),r=document.getElementById("commentsfield").value.toString().trim(),i=0;return null!=t&&(i=parseInt(t.value)),{name:e,rating:i,comments:r}},submitReviewForm=function(e){switch(e.preventDefault(),self.reviewsModification){case"add":submitNewReview();break;case"edit":submitReviewEditing()}},submitNewReview=function(){var e=getUserInput(),t=getFormErrors(e);if(t.length>0)displayReviewFormErrors(t);else{var r=e;r.restaurant_id=self.restaurant._id,r.createdAt=(new Date).toUTCString(),r.updatedAt=(new Date).toUTCString(),hideAddReviewModal(),DBHelper.postReview(r).then(function(e){switch(e.request_status){case"fail":generateFailureNotification(DBHelper.INDEXED_DB_SUPPORT),DBHelper.INDEXED_DB_SUPPORT&&(self.reviews.push(e.data),fillRatingStats(),fillReviewsHTML(),DBHelper.updateIndexedDB({target:"review",data:e.data},"POST"));break;default:self.reviews.push(e.data),fillRatingStats(),fillReviewsHTML()}})}},submitReviewEditing=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.editableReview,t=getUserInput();if(t.name.toLowerCase()===e.name.toLowerCase()&&parseInt(t.rating)===parseInt(e.rating)&&t.comments.toLowerCase()===e.comments.toLowerCase())hideAddReviewModal();else{var r=getFormErrors(t);if(r.length>0)displayReviewFormErrors(r);else{var i=t;i.restaurant_id=self.restaurant._id,i.createdAt=e.createdAt,i.updatedAt=(new Date).toUTCString(),i.id=e.id,i._id=e._id,hideAddReviewModal(),DBHelper.updateReview(i).then(function(e){switch(e.request_status){case"fail":generateFailureNotification(DBHelper.INDEXED_DB_SUPPORT),DBHelper.INDEXED_DB_SUPPORT&&(DBHelper.updateIndexedDB({target:"review",data:i},"PUT"),updateViewAfterReviewEdit(e.data));break;default:updateViewAfterReviewEdit(e.data)}})}}},updateViewAfterReviewEdit=function(e){for(var t=[],r=0;r<self.reviews.length;r++)self.reviews[r]._id===e._id?t.push(e):t.push(self.reviews[r]);self.reviews=[],self.reviews=t,fillRatingStats(),fillReviewsHTML()},deleteReview=function(e){var t=e.target.id.split("_").pop();DBHelper.deleteReview(t).then(function(e){switch(e.request_status){case"fail":if(generateFailureNotification(DBHelper.INDEXED_DB_SUPPORT),DBHelper.INDEXED_DB_SUPPORT){var r=self.reviews.filter(function(e){return e._id==t})[0];DBHelper.updateIndexedDB({target:"review",data:r},"DELETE"),self.reviews=self.reviews.filter(function(e){return e._id!=t}),fillRatingStats(),fillReviewsHTML()}break;default:self.reviews=self.reviews.filter(function(e){return e._id!=t}),fillRatingStats(),fillReviewsHTML()}})};
