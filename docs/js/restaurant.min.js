"use strict";var initMap=function(a,t,e,o){var n={integrity:"sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==",crossorigin:" "};loadStyle("https://unpkg.com/leaflet@1.3.1/dist/leaflet.css",function(){loadScript("https://unpkg.com/leaflet@1.3.1/dist/leaflet.js",function(){self.newMap=L.map("map",{center:[a,t],zoom:e,scrollWheelZoom:!1}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token={mapboxToken}",{mapboxToken:"pk.eyJ1Ijoia2F0ZXJpbmF0emlhbGEiLCJhIjoiY2pwenNqdHF3MGU5MDQ4bzRudGdlanZ6eCJ9.kGbzX08otPecWpIvfKU3ZA",maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(self.newMap),self.initialized_map=!0,o()},n)},{integrity:"sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==",crossorigin:" "})},addMarkersToMap=function(a){a.forEach(function(a){var t=mapMarkerForRestaurant(a,self.newMap);function e(){window.location.href=t.options.url}self.markers.push(t),t.on("click",e),t.on("keypress",function(a){13===a.originalEvent.keyCode&&e()})})},displayHideMap=function(a){a.map_display?(a.map_container.classList.remove("hidden"),setTimeout(function(){a.map_container.classList.add("displaymap")},200)):(a.map_container.classList.remove("displaymap"),setTimeout(function(){a.map_container.classList.add("hidden")},800)),self.initialized_map||setTimeout(function(){initMap(a.lat,a.lng,a.map_zoom,function(){addMarkersToMap(a.restaurants)})},800)},mapMarkerForRestaurant=function(a,t){var e=new L.marker([a.latlng.lat,a.latlng.lng],{title:a.name,alt:a.name,url:DBHelper.urlForRestaurant(a)});return e.addTo(t),e};
"use strict";var focusAfterError=[],reviewInitiator="",reviewsModification="",editableReview=[],editReview=function(e){self.editableReview=[],self.reviewInitiator="",self.reviewsModification="edit",self.reviewInitiator=document.getElementById(e.target.id);var t=e.target.id.split("_").pop();self.editableReview=self.reviews.filter(function(e){return e.id==t})[0],displayAddReviewModal()},toggleReviewForm=function(e){switch(e.target.getAttribute("id").split("_").pop()){case"close":hideAddReviewModal();break;case"open":self.reviewInitiator="",self.reviewInitiator=document.getElementById("rev_btn_open"),self.reviewsModification="add",displayAddReviewModal()}},displayAddReviewModal=function(){"rev_btn_open"===self.reviewInitiator.id?initReviewForm():initEditReviewForm(),displayElement(self.reviewLayer),document.getElementById("namefield").focus()},hideAddReviewModal=function(){hideElement(self.reviewLayer),initReviewForm(),removeFormErrors(),self.reviewInitiator.focus(),self.editableReview=[],self.reviewsModification="",self.reviewInitiator=""},initRatingStars=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.ratingStars,t=0;t<e.length;t++)e[t].classList.remove("selected"),document.getElementById(e[t].getAttribute("for")).removeAttribute("checked")},checkStars=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:self.ratingStars;initRatingStars();var r=t[e];r.focus();var i=document.getElementById(r.getAttribute("for"));i.setAttribute("checked",!0);for(var s=0;s<i.value;s++)t[s].classList.add("selected")},selectRatingStar=function(e){var t=parseInt(e.target.id.split("star").pop());checkStars((t+4)%5)},getFormErrors=function(e){self.focusAfterError=[];for(var t=[],r=Object.keys(e),i=0;i<r.length;i++){var s=r[i];if("name"===s){var a=textValidation(e.name,2,!0);null!=a&&(t.push(a+" your name!"),self.focusAfterError.push("namefield"))}if("rating"===s&&0==e.rating&&(t.push("Please provide a rating for the restaurant by selecting the respective number of stars!"),self.focusAfterError.push("rrstar_1")),"comments"===s){var n=textValidation(e.comments,1);null!=n&&(t.push(n+" your comments!"),self.focusAfterError.push("commentsfield"))}}return t},textValidation=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=new RegExp("^[0-9]+$"),s=new RegExp("^(?=.*[a-zA-Z]).{2,}$");return""===e?"Please provide":""===e.replace(/\s+/,"")?"Only spaces are NOT allowed for":i.test(e)?"Only numbers are NOT allowed for":e.length<t?"At least "+(1===t?"one character":"two characters")+" are required for":!s.test(e)&&e.length>=2&&!0===r?"At least one letter is required for":null},displayReviewFormErrors=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:self.reviewModal,r=document.createElement("div");r.className="formError",r.setAttribute("role","alert"),r.setAttribute("aria-live","assertive");var i=document.createElement("i");i.classList.add("material-icons","formwarning"),i.innerHTML="warning";var s=document.createElement("h4");s.className="errortitle",s.innerHTML="There are some errors in your review!";var a=document.createElement("ol");a.setAttribute("id","errorsList"),a.setAttribute("aria-label","error list of review");for(var n=0;n<e.length;n++){var o=document.createElement("li");o.setAttribute("role","listitem"),o.innerHTML=e[n],a.append(o)}var l=createButton("error_close_btn","ok","close form errors",closeFormErrors);l.title="Close form errors!",r.append(i,s,a,l),t.append(r),document.getElementById("error_close_btn").focus()},removeFormErrors=function(){var e=document.querySelectorAll(".formError");e.length>0&&e[0].remove(),self.focusAfterError=[]},closeFormErrors=function(e){document.getElementById(self.focusAfterError[0]).focus(),removeFormErrors()},initReviewForm=function(){initRatingStars(),document.getElementById("namefield").value="",document.getElementById("commentsfield").value=""},initEditReviewForm=function(){checkStars(self.editableReview.rating-1),document.getElementById("namefield").value=self.editableReview.name,document.getElementById("commentsfield").value=self.editableReview.comments},clearReviewForm=function(e){e.preventDefault(),initReviewForm(),removeFormErrors()},trapModalKeys=function(e){var t=document.querySelectorAll(".modalfocusable"),r=t[0],i=t[t.length-1],s=e.target.id;if(27===e.keyCode)e.preventDefault(),hideAddReviewModal();else if(13===e.keyCode&&s.startsWith("rrstar_")){e.preventDefault();var a=parseInt(s.split("_").pop());checkStars((a+4)%5)}else if(13===e.keyCode&&"namefield"===s)e.preventDefault();else if(9===e.keyCode&&!0===e.shiftKey){if("rev_btn_close"===s)e.preventDefault(),document.querySelectorAll(".formError").length>0?document.getElementById("error_close_btn").focus():i.focus();else s.startsWith("rrstar_")?(e.preventDefault(),t[1].focus()):"error_close_btn"===s&&(e.preventDefault(),r.focus())}else if(9===e.keyCode&&!1===e.shiftKey){if("error_close_btn"===s||"rev_submit"===s)e.preventDefault(),r.focus();else if("namefield"===s)e.preventDefault(),self.ratingStars[0].focus();else if(s.startsWith("rrstar_"))e.preventDefault(),t[7].focus();else if("rev_btn_close"===s){document.querySelectorAll(".formError").length>0&&(e.preventDefault(),document.getElementById("error_close_btn").focus())}}else if(39!==e.keyCode&&40!==e.keyCode||!s.startsWith("rrstar_")){if(37!==e.keyCode&&38!==e.keyCode||!s.startsWith("rrstar_"))return;e.preventDefault();var n=parseInt(s.split("_").pop());checkStars((n+3)%5)}else{e.preventDefault();var o=s.split("_").pop();checkStars(o)}},getUserInput=function(){var e=document.getElementById("namefield").value.toString().trim(),t=document.querySelector('input[name="userrating"]:checked'),r=document.getElementById("commentsfield").value.toString().trim(),i=0;return null!=t&&(i=parseInt(t.value)),{name:e,rating:i,comments:r}},submitReviewForm=function(e){switch(e.preventDefault(),self.reviewsModification){case"add":submitNewReview();break;case"edit":submitReviewEditing()}},submitNewReview=function(){var e=getUserInput(),t=getFormErrors(e);if(t.length>0)displayReviewFormErrors(t);else{var r=e;r.restaurant_id=self.restaurant._id,r.createdAt=(new Date).toISOString(),r.updatedAt=(new Date).toISOString(),hideAddReviewModal(),DBHelper.postReview(r).then(function(e){switch(e.request_status){case"fail":displayFailureNotification(e.idbsupport),e.idbsupport&&(self.reviews.push(e.data),fillRatingStats(),fillReviewsHTML());break;default:self.reviews.push(e.data),fillRatingStats(),fillReviewsHTML()}})}},submitReviewEditing=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.editableReview,t=getUserInput();if(t.name.toLowerCase()===e.name.toLowerCase()&&parseInt(t.rating)===parseInt(e.rating)&&t.comments.toLowerCase()===e.comments.toLowerCase())hideAddReviewModal();else{var r=getFormErrors(t);if(r.length>0)displayReviewFormErrors(r);else{var i=t;i.restaurant_id=e.restaurant_id,i.createdAt=e.createdAt,i.updatedAt=(new Date).toISOString(),i.id=e.id,i._id=e._id,hideAddReviewModal(),DBHelper.updateReview(i).then(function(e){switch(console.log(e),e.request_status){case"fail":displayFailureNotification(e.idbsupport),e.idbsupport&&(self.reviews=self.reviews.filter(function(e){return e._id!=i._id}),self.reviews.push(e.data),fillRatingStats(),fillReviewsHTML());break;default:self.reviews=self.reviews.filter(function(e){return e._id!=i._id}),self.reviews.push(e.data),fillRatingStats(),fillReviewsHTML()}})}}},deleteReview=function(e){var t=e.target.id.split("_").pop(),r=self.reviews.filter(function(e){return e.id==t})[0]._id;DBHelper.deleteReview(r).then(function(e){switch(e.request_status){case"fail":displayFailureNotification(e.idbsupport),e.idbsupport&&(self.reviews=self.reviews.filter(function(e){return e._id!=r}),fillRatingStats(),fillReviewsHTML());break;default:self.reviews=self.reviews.filter(function(e){return e._id!=r}),fillRatingStats(),fillReviewsHTML()}})};
"use strict";var restaurant=void 0,reviews=void 0,reviewsList=void 0,mapContainer=void 0,toggleButton=void 0,toggleBar=void 0,reviewLayer=void 0,reviewModal=void 0,ratingStars=void 0,renderRestaurant=function(){self.initialized_map=!1,self.markers=[],getRestaurantDomElements(),fetchRestaurantFromURL(function(e,t){e?console.error(e):(self.restaurant=t,fillBreadcrumb(),fillRestaurantHTML(),DBHelper.fetchRestaurantReviews(t._id,function(e,t){e?console.error(e):(self.reviews=t,fillRatingStats(),fillReviewsHTML(),hideLoader())}))}),self.toggleButton.addEventListener("mouseover",function(){self.toggleBar.classList.add("hoverBar")}),self.toggleButton.addEventListener("mouseout",function(){self.toggleBar.classList.remove("hoverBar")}),self.reviewLayer.addEventListener("keydown",trapModalKeys)},getRestaurantDomElements=function(){self.mapContainer=document.getElementById("map_container"),self.reviewsList=document.getElementById("reviewsList"),self.toggleButton=document.getElementById("favoriteToggle"),self.toggleBar=document.getElementById("favoriteBar"),self.reviewLayer=document.getElementById("add_review_wrapper"),self.reviewModal=document.getElementById("add_review_modal");var e=document.querySelectorAll(".rrstar"),t=Array.prototype.slice.call(e,0);self.ratingStars=t.reverse()},toggleMap=function(e){var t=document.getElementById("mapButton"),a=t.getAttribute("aria-label").split(" ")[0];handleMapButtonDisplay(t,a);var r={map_display:"show"===a,lat:self.restaurant.latlng.lat,lng:self.restaurant.latlng.lng,map_zoom:16,restaurants:[self.restaurant],map_container:self.mapContainer};displayHideMap(r)},handleMapButtonDisplay=function(e,t){var a="show"===t?"hide":"show",r="hide"===a?"map":"place";e.setAttribute("aria-label",a+" map"),e.title=a+" map";var n=e.getElementsByTagName("I")[0];n.innerHTML=r,"hide"===a?(n.classList.remove("location_icon"),n.classList.add("map_icon")):(n.classList.remove("map_icon"),n.classList.add("location_icon"))},fillRestaurantHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurant;handleFavoriteTogglerDisplay(e.is_favorite,!1),document.getElementById("restaurantName").innerHTML=e.name;var t=document.getElementById("restaurantImg");t.alt="photo of restaurant: "+e.name,t.className="restaurantImg",t.src=DBHelper.imageUrlForRestaurant(e),document.getElementById("cuisine").innerHTML=e.cuisine_type,document.getElementById("address").innerHTML="<span>"+e.neighborhood+"</span><span>"+e.address+"</span>",document.getElementById("commentsfield").placeholder='Enter your comments for the restaurant "'+self.restaurant.name+'" here!',e.operating_hours&&fillRestaurantHoursHTML()},fillRestaurantHoursHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurant.operating_hours,t=document.getElementById("restaurantHours");for(var a in e){var r=document.createElement("tr"),n=document.createElement("td");n.className="hoursDay",n.innerHTML=a,r.appendChild(n);var i=document.createElement("td");i.className="hoursTime",i.innerHTML=e[a],r.appendChild(i),t.appendChild(r)}},handleFavoriteTogglerDisplay=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a="true"===e.toString();self.toggleButton.setAttribute("aria-checked",a);var r=!0===a?"Unmark restaurant from favorites!":"Add restaurant to favorites!",n=!0===a?"remove restaurant from favorites":"mark restaurant as favorite";self.toggleButton.setAttribute("title",r),self.toggleButton.setAttribute("aria-label",n);var i=!0===a?"markedFavorite":"unFavorite",s=!0===a?"unFavorite":"markedFavorite";self.toggleBar.classList.remove(s),self.toggleBar.classList.add(i),!0===t&&self.toggleButton.classList.add("toggleTransition")},favoriteToggler=function(e){var t="true"!==document.getElementById("favoriteToggle").getAttribute("aria-checked").toString();handleFavoriteTogglerDisplay(t),DBHelper.favoriteHandler(self.restaurant._id,t).then(function(e){switch(e.request_status){case"fail":displayFailureNotification(e.idbsupport),e.idbsupport&&(handleFavoriteTogglerDisplay(e.data.is_favorite),self.restaurant.is_favorite=e.data.is_favorite);break;default:handleFavoriteTogglerDisplay(e.data.is_favorite),self.restaurant.is_favorite=e.data.is_favorite}})},fillRatingStats=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.reviews,t=document.getElementById("restaurantTotals"),a=t.getElementsByTagName("SPAN"),r=e.length;if(a[2].innerHTML=r,r>0){var n=0;e.forEach(function(e){n+=parseInt(e.rating)});var i=Number(Math.round(n/r+"e1")+"e-1");a[0].innerHTML=i}1===r&&(t.getElementsByTagName("A")[0].innerHTML="review")},fillReviewsHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.reviews,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:self.reviewsList;self.reviewsList.innerHTML="",e&&0!==e.length?(e.sort(function(e,t){var a=sortByDate(e,t,"desc","updatedAt"),r=sortByDate(e,t,"desc","createdAt"),n=sortByID(e,t,"desc");return a||r||n}),removeFetcherMessage(),e.forEach(function(e){t.appendChild(createReviewHTML(e))})):fetcherMessage("reviews",document.getElementById("reviews"),self.reviewsList)},createReviewHTML=function(e){var t=document.createElement("li");if(t.className="reviewCard",t.setAttribute("role","listitem"),parseInt(e.id)>24||e.id.toString().startsWith("temp")){var a=createButton("edit_rev_"+e.id,"edit","edit review",editReview);a.title="Edit Review",a.classList.add("material-icons","review_modification_btn","edirreview");var r=createButton("delete_rev_"+e.id,"delete","delete review",deleteReview);r.title="Delete Review",r.classList.add("material-icons","review_modification_btn","deletereview"),t.append(r,a)}var n=populateReviewRating(e.rating),i=document.createElement("div");i.className="reviewInfo";var s=document.createElement("p");s.className="reviewer",s.innerHTML='<span>by</span><b title="'+e.name+'">'+e.name+"</b>";var o=document.createElement("p");if(o.className="reviewCreationDate",o.innerHTML=formatDate(e.createdAt),i.append(s,o),new Date(e.updatedAt).getTime()>new Date(e.createdAt).getTime()){var l=document.createElement("p");l.className="reviewUpdateDate",l.innerHTML="Last updated: "+getDateTime(e.updatedAt),i.append(l)}var d=document.createElement("p");return d.className="ratingComments",d.innerHTML=decodeEntities(e.comments),t.append(n,i,d),t},populateReviewRating=function(e){var t=document.createElement("div");t.classList.add("centeredFlexbox","reviewRating");var a=document.createElement("p");a.className="ratingHeader",a.innerHTML="rating:",t.append(a);for(var r=1;r<6;r++){var n=document.createElement("div");n.innerHTML="star",n.classList.add("material-icons","star_for_review"),r<=e&&n.classList.add("given_star"),t.append(n)}return t},formatDate=function(e){var t=new Date(e).toString().split(" ");return t[2]+" "+t[1]+" "+t[3]},getDateTime=function(e){return formatDate(e)+", "+getTime(e)},getTime=function(e){var t=new Date(e);return(t.getHours()<10?"0":"")+t.getHours()+":"+((t.getMinutes()<10?"0":"")+t.getMinutes())},decodeEntities=function(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value},fillBreadcrumb=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurant,t=document.getElementById("breadcrumb"),a=document.createElement("li"),r=document.createElement("a");r.innerHTML=e.name,r.href=DBHelper.urlForRestaurant(e),r.setAttribute("aria-current","page"),a.append(r),t.appendChild(a)},fetchRestaurantFromURL=function(e){if(self.restaurant)e(null,self.restaurant);else{var t=getParameterByName("id");t?DBHelper.fetchRestaurantById(t,function(t,a){self.restaurant=a,a?e(null,a):console.error(t)}):(error="No restaurant id in URL",e(error,null))}},getParameterByName=function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var a=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return a?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null},sortByDate=function(e,t,a,r){var n=void 0;return"asc"===a?n=parseFloat(new Date(e[r]).getTime())-parseFloat(new Date(t[r]).getTime()):"desc"===a&&(n=parseFloat(new Date(t[r]).getTime())-parseFloat(new Date(e[r]).getTime())),n};
